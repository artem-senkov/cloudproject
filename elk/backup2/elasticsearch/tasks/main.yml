---
#
# Installing Elasticsearch
#

# Add Elasticsearch apt key

#- name: Add Elasticsearch apt key
#  apt_key:
#   url: "https://packages.elastic.co/GPG-KEY-elasticsearch"
#   state: present

# Add the Elasticsearch apt repo. For versions 6 of the stack - use '6.x-prerelease':

#- name: Adding Elasticsearch repo
#  apt_repository:
#   repo: deb https://artifacts.elastic.co/packages/5.x/apt stable main
#   state: present

- name: Import a key for alternative repository
  ansible.builtin.apt_key:
    state: present
    url: http://elasticrepo.serveradmin.ru/elastic.asc

- name: Add alternative repository
  ansible.builtin.apt_repository:
    repo: deb http://elasticrepo.serveradmin.ru bullseye main
    state: present
    filename: elasticrepo



# Installing Elasticsearch

- name: Install Elasticsearch
  apt:
   name: elasticsearch
   update_cache: yes
   
# Update Elasticsearch config file to allow access (to secure Elasticsearch, bind to 'localhost'). 

- name: Updating the config file to allow outside access
  lineinfile:
   destfile: /etc/elasticsearch/elasticsearch.yml
   regexp: 'network.host:'
   line: 'network.host: 0.0.0.0'
 
# Update Elasticsearch port in config file 

- name: Updating the port in config file 
  lineinfile:
   destfile: /etc/elasticsearch/elasticsearch.yml
   regexp: 'http.port:'
   line: 'http.port: 9200'
 
# Disable security connection only
- name: replace line for disabling security connection only 1
  lineinfile:
   destfile: /etc/elasticsearch/elasticsearch.yml
   regexp: '^  enabled: true'
   insertafter: 'xpack.security.http.ssl:'
   line: '  enabled: false'

- name: replace line for disabling security connection only 2
  lineinfile:
   destfile: /etc/elasticsearch/elasticsearch.yml
   regexp: '^xpack.security.enabled: true'
   line: 'xpack.security.enabled: false'

- name: replace line for disabling security connection only 3
  lineinfile:
   destfile: /etc/elasticsearch/elasticsearch.yml
   regexp: '^xpack.security.enrollment.enabled: true'
   line: 'xpack.security.enrollment.enabled: false'


# Enable and Start Elasticsearch
- name: Starting Elasticsearch
  service:
   name: elasticsearch
   state: started
   enabled: true
   daemon-reload: yes
